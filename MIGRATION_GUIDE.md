# Руководство по миграции: Добавление поддержки организаций

## Обзор изменений

Данная миграция добавляет поддержку мультиорганизационной системы в приложение warehouse-turbo. Теперь пользователи могут создавать и управлять несколькими организациями.

## Изменения в базе данных

### Новые таблицы

1. **Organization** - основная таблица организаций
   - `id` - уникальный идентификатор
   - `name` - название организации
   - `description` - описание (опционально)
   - `createdAt`, `updatedAt` - временные метки
   - `active` - статус активности

2. **UserOrganization** - связь пользователей с организациями (многие-ко-многим)
   - `id` - уникальный идентификатор
   - `userId` - ID пользователя
   - `organizationId` - ID организации
   - `role` - роль пользователя в организации
   - `isOwner` - является ли владельцем
   - `createdAt`, `updatedAt` - временные метки

### Обновленные таблицы

Все существующие таблицы получили поле `organizationId`:
- **Product** - продукты теперь принадлежат организации
- **Receipt** - чеки привязаны к организации
- **ShiftReport** - отчеты о сменах принадлежат организации
- **AllowedPhone** - разрешенные телефоны привязаны к организации

## Backend изменения

### Новые модули

1. **OrganizationModule** - основной модуль для управления организациями
2. **OrganizationController** - API endpoints для CRUD операций
3. **OrganizationService** - бизнес-логика управления организациями

### Новые guards и middleware

1. **OrganizationAccessGuard** - проверка доступа к организации
2. **OrganizationContextMiddleware** - автоматическое определение организации из заголовков

### Новые декораторы

1. **@OrganizationId()** - получение ID организации из request
2. **@CurrentOrganization()** - получение текущей организации

### Обновленные сервисы

- **ProductsService** - добавлена поддержка фильтрации по организации
- **ProductsController** - добавлена проверка organizationId

## Frontend изменения

### Новые типы

- `IOrganization` - интерфейс организации
- `IUserOrganization` - интерфейс связи пользователя с организацией
- `ICreateOrganization` - интерфейс для создания организации
- `IUpdateOrganization` - интерфейс для обновления организации

### Новые API функции

- `useOrganizations()` - получение всех организаций
- `useMyOrganizations()` - получение организаций пользователя
- `useCreateOrganization()` - создание организации
- `useUpdateOrganization()` - обновление организации
- `useDeleteOrganization()` - удаление организации
- `useAddUserToOrganization()` - добавление пользователя в организацию
- `useRemoveUserFromOrganization()` - удаление пользователя из организации
- `useUpdateUserRole()` - обновление роли пользователя

### Новые компоненты

1. **OrganizationSelector** - селектор организации
2. **OrganizationManagementPage** - страница управления организациями

### Новые stores

- **useOrganizationStore** - управление текущей организацией

## Инструкции по миграции

### 1. Выполнение миграции базы данных

```bash
cd apps/server
npx prisma migrate dev --name add_organizations
```

### 2. Генерация Prisma клиента

```bash
npx prisma generate
```

### 3. Запуск приложения

```bash
# Backend
cd apps/server
npm run start:dev

# Frontend
cd apps/frontend
npm run dev
```

## Тестирование

### 1. Создание организации

1. Войдите в приложение
2. Перейдите в раздел "Организации"
3. Нажмите "Создать организацию"
4. Заполните название и описание
5. Нажмите "Создать"

### 2. Добавление пользователей

1. Откройте созданную организацию
2. Нажмите кнопку "Пользователи"
3. Добавьте пользователей с соответствующими ролями

### 3. Проверка изоляции данных

1. Переключитесь между организациями
2. Убедитесь, что данные (продукты, чеки) отображаются только для выбранной организации

## Важные замечания

### Безопасность

- Все API endpoints защищены проверкой принадлежности пользователя к организации
- Роли пользователей теперь привязаны к конкретной организации
- Владелец организации имеет полные права в своей организации

### Производительность

- Добавлены индексы для быстрого поиска по organizationId
- Используется каскадное удаление для связанных данных

### Обратная совместимость

- Существующие данные автоматически переносятся в дефолтную организацию
- Существующие пользователи получают роль OWNER в дефолтной организации

## Следующие шаги

1. Добавить поддержку организаций во все остальные модули (Receipts, Shifts, etc.)
2. Создать интерфейс для управления пользователями организаций
3. Добавить настройки организаций
4. Реализовать уведомления на уровне организаций
5. Добавить аналитику по организациям

## Поддержка

При возникновении проблем с миграцией:

1. Проверьте логи сервера
2. Убедитесь, что все зависимости установлены
3. Проверьте подключение к базе данных
4. Обратитесь к документации Prisma для дополнительной информации 